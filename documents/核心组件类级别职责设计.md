核心组件类级别职责设计
1. AgentOrchestrator（核心编排器）
核心职责：

作为整个 Agent 的调度中心，控制请求处理的全流程
维护代码级状态机，根据各模块返回结果决定状态流转
按固定顺序调用：意图识别 → 槽位抽取 → 权限校验 → 工具执行 → 响应生成
处理各类异常场景，触发对应的兜底策略
确保每次请求最终到达终态（DONE / HANDOFF / REJECT / ERROR）
输入：

ConversationContext
：当前会话上下文（含历史、状态）
String userMessage：用户本轮输入
输出：

AgentResponse
：包含回复内容、会话状态、是否需转人工
明确禁止：

禁止直接调用 LLM（必须通过 IntentRecognizer / ResponseGenerator）
禁止直接访问数据库或外部 API（必须通过 ToolExecutor）
禁止生成任何自由文本内容
禁止将"下一步做什么"的决策权交给 LLM
2. IntentRecognizer（意图识别器）
核心职责：

调用 LLM 将用户自然语言输入转换为预定义的意图类型
返回意图类型（IntentType 枚举）和置信度分数
提供对话历史摘要给 LLM 作为上下文参考
输入：

ConversationContext
：对话上下文（用于提取历史摘要）
String userMessage：用户输入
输出：

IntentResult
：包含 intentType（枚举值）、confidence（0.0-1.0）、rawInput
明确禁止：

禁止接受 LLM 返回的非预定义意图类型
禁止在此模块内执行任何业务操作
禁止直接修改会话状态
禁止将用户原始输入未经结构化处理直接拼入 Prompt
3. SlotExtractor（槽位抽取器）
核心职责：

根据已识别的意图类型，确定需要抽取的槽位列表
调用 LLM 从用户输入中抽取槽位值
对抽取结果进行格式校验（正则、类型、范围）
明确标记哪些必填槽位缺失
输入：

IntentResult
：已识别的意图（含意图类型和原始输入）
输出：

IntentResult
：补充了 slots（Map<String, Object>）和 missingSlots（List）
明确禁止：

禁止推断或补全用户未明确提供的信息
禁止绕过格式校验直接返回 LLM 原始输出
禁止执行任何业务操作
禁止接受不在预定义列表中的槽位名
4. ToolExecutor（工具执行器）
核心职责：

根据意图类型从 ToolRegistry 中选择对应的 Tool
校验工具所需参数是否完整
调用 Tool.execute() 并获取结构化执行结果
对执行结果进行后校验（脱敏、行数限制）
输入：

IntentType：意图类型（用于选择工具）
Map<String, Object> params：槽位参数
ToolContext
：执行上下文（userId、traceId、权限级别）
输出：

ToolResult
：包含 success、data（Map）、errorCode、errorMessage、dataSource
明确禁止：

禁止让 LLM 决定调用哪个工具
禁止绕过参数校验直接执行
禁止返回未脱敏的原始数据库记录
禁止直接拼接 SQL 语句
5. Tool（工具接口）
核心职责：

定义工具的标准契约：名称、描述、必填参数、执行方法
所有业务能力必须实现此接口才能被 ToolExecutor 调用
输入：

Map<String, Object> params：执行参数
ToolContext
：执行上下文
输出：

ToolResult
：结构化执行结果
明确禁止：

禁止在接口层定义任何业务逻辑
禁止定义与执行无关的方法
6. SqlQueryTool（SQL 查询工具）
核心职责：

执行预定义的 SQL 模板，获取数据库数据
使用 PreparedStatement 绑定参数，防止 SQL 注入
限制返回行数（如最大 100 行）
脱敏敏感字段后返回结果
输入：

Map<String, Object> params：查询参数（如 order_id）
ToolContext
：包含 userId（用于权限判断）
输出：

ToolResult
：包含查询结果（单条为 Map，多条为 List）、数据来源（视图/表名）
明确禁止：

禁止接受动态 SQL 语句
禁止由 LLM 生成 SQL
禁止返回超过限定行数的结果
禁止返回密码、身份证号等敏感字段明文
7. RagQueryTool（RAG 检索工具）
核心职责：

将查询文本转换为向量，调用向量数据库检索
返回 Top-K 相关文档，带相似度分数
过滤低于阈值（如 0.7）的结果
每条结果附带来源标注（文档ID、来源路径）
输入：

Map<String, Object> params：包含 query（查询文本）、category（分类，可选）
ToolContext
：执行上下文
输出：

ToolResult
：包含 documents（List，每条含 content、similarity、source、docId）
明确禁止：

禁止返回无来源标注的内容
禁止返回低于相似度阈值的结果
禁止对检索结果进行 LLM 二次改写
8. LLMClient（LLM 客户端）
核心职责：

抽象大模型调用，提供统一接口
管理 Prompt 模板，所有调用必须使用模板
记录每次调用的输入输出、耗时、token 用量
实现超时控制、重试机制、降级策略
输入：

LLMRequest
：包含 prompt、maxTokens、temperature、systemPrompt
输出：

LLMResponse
：包含 success、content、errorMessage、promptTokens、completionTokens、latency
明确禁止：

禁止将用户原始输入未经模板处理直接作为 prompt
禁止在 prompt 中包含敏感信息（数据库连接、API Key）
禁止让 LLM 返回的内容不经校验直接作为最终响应
禁止在此模块内做业务逻辑判断
9. FallbackManager（兜底管理器）
核心职责：

管理各类异常场景的兜底策略
根据异常类型决定处理方式：重试、询问澄清、拒答、转人工
维护固定话术库，LLM 不可用时返回预设回复
记录兜底触发事件用于分析优化
输入：

ConversationContext
：会话上下文
Exception：异常对象（或异常类型标识）
输出：

AgentResponse
：兜底后的响应（可能是固定话术或转人工指令）
明确禁止：

禁止在兜底场景中调用 LLM 生成回复
禁止暴露内部错误详情给用户
禁止绕过转人工逻辑直接终止会话
10. HumanHandoffService（人工转接服务）
核心职责：

封装转人工的完整流程
保存当前会话上下文和对话历史，供人工客服查看
通知人工客服系统有新待接会话
记录转接事件用于审计
输入：

ConversationContext
：会话上下文
输出：

void（或转接工单ID）
明确禁止：

禁止在转接过程中丢失对话历史
禁止未通知客服系统就标记为已转接
禁止向用户暴露客服系统内部状态
11. SessionManager（会话管理器）
核心职责：

管理会话的完整生命周期：创建、获取、更新、销毁
维护会话存储（本地缓存 / Redis）
处理会话超时和过期清理
为每次请求生成新的 traceId
输入：

String sessionId：会话ID
String userId：用户ID
输出：

ConversationContext
：会话上下文对象
明确禁止：

禁止在此模块内做意图识别或业务处理
禁止将完整对话历史不加处理地暴露给 LLM
禁止让会话数据不经脱敏直接写入日志
组件依赖关系图
```
AgentOrchestrator
    ├── SessionManager          （获取/保存会话上下文）
    ├── IntentRecognizer        （意图识别）
    │       └── LLMClient
    ├── SlotExtractor           （槽位抽取）
    │       └── LLMClient
    ├── PermissionChecker       （权限校验）
    ├── ToolExecutor            （工具执行）
    │       ├── SqlQueryTool
    │       ├── RagQueryTool
    │       └── ...其他工具
    ├── ResponseGenerator       （响应生成）
    │       └── LLMClient
    ├── FallbackManager         （兜底处理）
    │       └── HumanHandoffService
    └── AgentLogger             （日志记录）
```

核心调用链：
```
Controller → Orchestrator → [IntentRecognizer → SlotExtractor → ToolExecutor → ResponseGenerator] → Response
                ↑                                                                                      ↓
         SessionManager ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
```