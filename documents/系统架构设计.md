系统架构分层定义（冻结版）
第一层：API 接入层
必须做：

接收 HTTP/WebSocket 请求，校验请求格式（JSON Schema）
提取并校验必填字段：sessionId、userId、message
生成本次请求的 traceId，贯穿全链路
调用风控层进行前置拦截（限流、黑名单）
将请求转发给 Orchestrator，等待响应后返回
禁止做：

禁止在此层做任何业务逻辑判断
禁止在此层调用 LLM
禁止在此层直接访问数据库
禁止在此层处理意图识别或槽位抽取
第二层：会话管理层
必须做：

维护会话生命周期：创建、获取、更新、过期清理
存储结构化对话历史（role + content + timestamp）
维护会话级状态：当前 AgentState、待补充的槽位、未识别计数
提供会话上下文给 Orchestrator 和意图识别层
支持多轮对话的上下文传递（最近 N 轮摘要）
禁止做：

禁止在此层做意图识别
禁止在此层调用 LLM
禁止将原始对话历史全量拼接给 LLM（防止 Prompt 注入）
禁止在此层做业务决策
第三层：Agent 编排层（Orchestrator）
必须做：

维护代码级状态机，定义所有合法状态转换路径
按顺序调用：意图识别 → 槽位抽取 → 权限校验 → 工具执行 → 响应生成
根据各模块返回结果决定状态流转（非 LLM 决策）
处理异常情况：未识别意图、槽位缺失、工具失败、权限拒绝
触发兜底策略：转人工、拒答、澄清追问
确保每次请求最终到达终态（DONE / HANDOFF / REJECT）
禁止做：

禁止将"下一步做什么"交给 LLM 判断
禁止在此层直接访问数据库或外部 API
禁止在此层生成自由文本（响应生成由专门模块负责）
禁止跳过权限校验直接执行工具
第四层：意图识别 & Slot 抽取层
必须做：

调用 LLM 识别意图，输出必须为预定义的 IntentType 枚举值
返回置信度分数，低于阈值（如 0.7）标记为 UNKNOWN
根据意图类型定义必填槽位列表，调用 LLM 抽取
对抽取结果进行格式校验（正则、类型、范围）
明确标记哪些必填槽位缺失
禁止做：

禁止让 LLM 自创意图类型
禁止让 LLM 推断或补全缺失参数
禁止在此层执行任何业务操作
禁止将用户原始输入直接拼接进 Prompt（需结构化处理）
第五层：工具层（SQL / RAG / API / Rule）
必须做：

定义 Tool 接口规范：入参校验、执行、返回结构化结果
SQL 工具：只执行预定义模板 SQL，参数使用 PreparedStatement
RAG 工具：执行向量检索，返回带来源标注的结构化结果
API 工具：调用内部/外部服务，带超时和重试机制
Rule 工具：执行规则引擎判断（如是否允许退款）
所有工具返回统一结构：success / data / errorCode / dataSource
禁止做：

禁止 LLM 生成 SQL 语句
禁止 LLM 决定调用哪个工具（由 Orchestrator 根据意图决定）
禁止返回原始数据库记录（需脱敏、裁剪）
禁止返回超过限定行数的结果（防数据泄露）
第六层：权限校验 & 风控层
必须做：

限流控制：按用户/IP 限制请求频率
黑名单校验：拦截已知恶意用户
注入检测：识别 SQL 注入、XSS 攻击模式
敏感词过滤：输入和输出双向过滤
资源归属校验：用户是否有权访问该订单/账户
高风险操作拦截：退款、投诉等需二次确认或转人工
禁止做：

禁止在此层做业务逻辑处理
禁止绕过权限校验直接返回数据
禁止将校验失败的原因详细暴露给用户（防信息泄露）
禁止在此层调用 LLM
第七层：LLM 接入层
必须做：

抽象 LLM 调用接口，支持多厂商切换（DeepSeek / OpenAI / 本地模型）
管理 Prompt 模板，所有 LLM 调用必须使用模板
记录每次调用的输入输出、耗时、token 用量
实现超时控制和重试机制
实现降级策略：LLM 不可用时返回固定话术
禁止做：

禁止将用户原始输入未经处理直接作为 Prompt
禁止在 Prompt 中包含数据库连接信息、API Key 等敏感信息
禁止让 LLM 返回的内容直接作为最终响应（需校验）
禁止在此层做业务逻辑判断
第八层：日志 & 评估层
必须做：

记录全链路日志：请求 → 意图 → 槽位 → 权限 → 工具 → 响应
每条日志带 traceId，支持全链路追踪
记录所有 LLM 调用的 Prompt 和 Response（脱敏后）
记录状态机每次状态转换
支持异步写入，不阻塞主流程
提供指标采集：成功率、转人工率、平均响应时间
禁止做：

禁止记录用户敏感信息明文（身份证、银行卡、密码）
禁止同步写日志阻塞用户请求
禁止在日志中暴露内部模块实现细节
禁止将日志接口暴露给外部
层间调用规则（冻结）
API接入层 → 风控层 → Orchestrator → 意图识别层 → 工具层 → LLM层 → 工具层 → Orchestrator → API接入层
               ↑                          ↓
            会话管理层 ←←←←←←←←←←←←←←←←←←←←←
               ↓
            日志层（全程旁路记录）
核心原则：

所有跨层调用必须通过接口，禁止直接访问下层实现
Orchestrator 是唯一的调度中心，其他层不允许互相直接调用
日志层以旁路方式接入，不参与主流程